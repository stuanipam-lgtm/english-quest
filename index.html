<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quest - Monthly Challenge</title>
    <style>
        /* (Os estilos permanecem os mesmos) */
    </style>
</head>
<body>
    <div class="container">
        <!-- (O HTML permanece o mesmo) -->
    </div>

    <!-- Modal de senha -->
    <div id="passwordModal" class="modal">
        <!-- (O HTML permanece o mesmo) -->
    </div>

    <!-- Modal de edi√ß√£o -->
    <div id="editModal" class="modal">
        <!-- (O HTML permanece o mesmo) -->
    </div>

    <script>
        class EnglishQuest {
            constructor() {
                this.students = [];
                this.isAdminMode = false;
                this.isAuthenticated = false;
                this.adminPassword = '';
                this.firebaseUrl = '';
                this.currentEditStudent = null;
                this.syncInterval = null;
                this.isStudentView = false;
                this.lastUpdateTime = 0; // Controle de tempo para sincroniza√ß√£o
                
                this.levelThresholds = {
                    beginner: { min: 0, max: 50 },
                    adventurer: { min: 51, max: 150 },
                    hero: { min: 151, max: 300 },
                    master: { min: 301, max: Infinity }
                };
                
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkSystemStatus();
            }

            async checkSystemStatus() {
                const urlParams = new URLSearchParams(window.location.search);
                this.isStudentView = urlParams.get('view') === 'student';
                
                // Update page title for student view
                if (this.isStudentView) {
                    document.title = 'English Quest - Student Dashboard';
                }
                
                // Try to load system configuration from URL parameters (for students)
                const firebaseUrl = urlParams.get('firebase');
                
                if (firebaseUrl && this.isStudentView) {
                    // Student accessing with Firebase URL in parameters
                    this.firebaseUrl = decodeURIComponent(firebaseUrl);
                    this.adminPassword = 'student-readonly';
                    await this.loadStudentsFromFirebase();
                    this.showMainContent(true); // true = student view
                    this.startRealtimeSync();
                } else if (firebaseUrl) {
                    // Admin accessing with Firebase URL in parameters
                    this.firebaseUrl = decodeURIComponent(firebaseUrl);
                    await this.loadStudentsFromFirebase();
                    this.showMainContent(false);
                    this.startRealtimeSync();
                } else {
                    // First time setup required
                    this.showSetupSection();
                }
            }

            // ... (outros m√©todos permanecem iguais at√© o setupFirebaseSystem)

            async setupFirebaseSystem() {
                const url = document.getElementById('firebaseUrl').value.trim();
                const password = document.getElementById('adminPassword').value.trim();
                
                if (!url) {
                    alert('Please enter a Firebase URL');
                    return;
                }
                
                if (!password || password.length < 4) {
                    alert('Please set an admin password (minimum 4 characters)');
                    return;
                }

                try {
                    this.updateConnectionStatus('connecting');
                    this.firebaseUrl = url.endsWith('/') ? url : url + '/';
                    this.adminPassword = password;
                    
                    // Test connection
                    const response = await fetch(`${this.firebaseUrl}students.json`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Save admin config to Firebase
                    await fetch(`${this.firebaseUrl}config.json`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            adminPassword: btoa(password),
                            setupDate: new Date().toISOString()
                        })
                    });

                    // Load existing students
                    await this.loadStudentsFromFirebase();
                    
                    this.updateConnectionStatus('connected');
                    this.showMainContent(false);
                    this.showStudentLinkInfo();
                    this.startRealtimeSync();
                    
                } catch (error) {
                    console.error('Firebase setup error:', error);
                    this.updateConnectionStatus('disconnected');
                    alert(`Setup failed: ${error.message}\n\nPlease check your Firebase URL and try again.`);
                }
            }

            showMainContent(isStudentView = false) {
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                if (isStudentView) {
                    // Hide admin controls and selects for students, but show XP values
                    document.getElementById('adminToggle').style.display = 'none';
                    document.getElementById('adminStatus').style.display = 'none';
                    document.getElementById('addStudentSection').style.display = 'none';
                    
                    // For mission controls - hide selects but show XP values as display elements
                    document.querySelectorAll('.mission-controls').forEach(control => {
                        control.classList.add('student-view');
                        
                        // Hide the select dropdown and XP buttons for students
                        const select = control.querySelector('.mission-select');
                        if (select) {
                            select.style.display = 'none';
                        }
                        
                        // Hide XP buttons for students
                        const xpButton = control.querySelector('.xp-button');
                        if (xpButton) {
                            xpButton.style.display = 'none';
                        }
                    });
                    
                    // Add student welcome message
                    const existingStudentInfo = document.querySelector('.student-welcome-info');
                    if (!existingStudentInfo) {
                        const studentInfo = document.createElement('div');
                        studentInfo.className = 'student-welcome-info';
                        studentInfo.innerHTML = `
                            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                                <h3 style="margin-bottom: 10px;">üéÆ Welcome Students!</h3>
                                <p>Complete missions to earn XP and climb the leaderboard! Your teacher will award points when you complete tasks.</p>
                            </div>
                        `;
                        document.querySelector('.container').insertBefore(studentInfo, document.querySelector('.missions-section'));
                    }
                }
                
                this.renderStudents();
                this.updateSelects();
            }

            // ... (outros m√©todos permanecem iguais at√© addXpToStudent)

            async addXpToStudent(studentId, xpAmount) {
                // Verificar se √© admin antes de permitir altera√ß√µes
                if (!this.isAdminMode && !this.isStudentView) {
                    alert('Admin mode required to award XP!');
                    return;
                }
                
                // Bloquear completamente estudantes de fazer altera√ß√µes
                if (this.isStudentView) {
                    alert('Only teachers can award XP!');
                    return;
                }

                const student = this.students.find(s => s.id === studentId);
                if (student) {
                    const oldLevel = this.getStudentLevel(student.xp);
                    student.xp += xpAmount;
                    
                    if (student.xp < 0) {
                        student.xp = 0;
                    }
                    
                    const newLevel = this.getStudentLevel(student.xp);
                    
                    await this.saveStudentsToFirebase();
                    this.renderStudents();
                    
                    if (oldLevel !== newLevel && xpAmount > 0) {
                        this.showLevelUpCelebration(student.name, newLevel);
                    }
                }
            }

            // ... (outros m√©todos permanecem iguais at√© saveStudentsToFirebase)

            async saveStudentsToFirebase() {
                try {
                    // Atualizar o timestamp para controle de sincroniza√ß√£o
                    this.lastUpdateTime = Date.now();
                    
                    const studentsData = {};
                    this.students.forEach(student => {
                        studentsData[student.id] = {
                            name: student.name,
                            xp: student.xp,
                            lastUpdated: this.lastUpdateTime
                        };
                    });

                    const response = await fetch(`${this.firebaseUrl}students.json`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(studentsData)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to save: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    alert('Error saving data. Please check your connection.');
                }
            }

            // ... (outros m√©todos permanecem iguais at√© startRealtimeSync)

            startRealtimeSync() {
                // Sincroniza√ß√£o em tempo real - verificar a cada 2 segundos
                this.syncInterval = setInterval(async () => {
                    try {
                        // Verificar se h√° atualiza√ß√µes no servidor
                        const response = await fetch(`${this.firebaseUrl}students.json?time=${Date.now()}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data) {
                                // Verificar se h√° dados mais recentes no servidor
                                let needsUpdate = false;
                                const serverStudents = Object.keys(data).map(key => ({...data[key], id: key}));
                                
                                for (const serverStudent of serverStudents) {
                                    const localStudent = this.students.find(s => s.id === serverStudent.id);
                                    
                                    if (!localStudent || 
                                        (serverStudent.lastUpdated && 
                                         serverStudent.lastUpdated > (localStudent.lastUpdated || 0))) {
                                        // Dados do servidor s√£o mais recentes
                                        needsUpdate = true;
                                        break;
                                    }
                                }
                                
                                if (needsUpdate) {
                                    await this.loadStudentsFromFirebase();
                                    this.renderStudents();
                                    this.updateSelects();
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Sync error:', error);
                        this.updateConnectionStatus('disconnected');
                    }
                }, 2000);
            }

            // ... (outros m√©todos permanecem iguais at√© renderStudents)

            renderStudents() {
                const container = document.getElementById('studentsContainer');
                
                if (this.students.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d;">
                            <h3>No students yet!</h3>
                            ${this.isStudentView ? '<p>The teacher will add students soon.</p>' : '<p>Enable admin mode and add your first student to get started.</p>'}
                        </div>
                    `;
                    return;
                }

                const sortedStudents = [...this.students].sort((a, b) => b.xp - a.xp);

                container.innerHTML = sortedStudents.map((student, index) => {
                    const level = this.getStudentLevel(student.xp);
                    const progress = this.getProgressToNextLevel(student.xp);
                    
                    // Mostrar controles diferentes para admin vs visualiza√ß√£o de estudante
                    let adminButtons = '';
                    
                    if (!this.isStudentView) {
                        adminButtons = `
                            <div class="buttons-container ${!this.isAdminMode ? 'disabled' : ''}">
                                <button class="xp-button btn-10" onclick="englishQuest.addXpToStudent('${student.id}', 10)" 
                                    ${!this.isAdminMode ? 'disabled' : ''}>+10 XP</button>
                                <button class="xp-button btn-15" onclick="englishQuest.addXpToStudent('${student.id}', 15)" 
                                    ${!this.isAdminMode ? 'disabled' : ''}>+15 XP</button>
                                <button class="xp-button btn-20" onclick="englishQuest.addXpToStudent('${student.id}', 20)" 
                                    ${!this.isAdminMode ? 'disabled' : ''}>+20 XP</button>
                                <button class="xp-button btn-edit" onclick="englishQuest.editStudent('${student.id}')" 
                                    ${!this.isAdminMode ? 'disabled' : ''}>‚úèÔ∏è Edit</button>
                                <button class="xp-button btn-delete" onclick="englishQuest.deleteStudent('${student.id}')" 
                                    ${!this.isAdminMode ? 'disabled' : ''}>üóëÔ∏è Remove</button>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="student-card">
                            <div class="student-name">
                                ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : ''} ${student.name}
                            </div>
                            <div class="student-level level-${level}">
                                ${this.getLevelDisplayName(level)}
                            </div>
                            
                            <div class="xp-info">
                                <div class="xp-current">${student.xp}</div>
                                <div class="xp-label">Total XP</div>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-bar progress-${level}" 
                                     style="width: ${progress.percent}%"></div>
                            </div>
                            
                            <div class="xp-label">
                                ${level === 'master' ? 'Max Level!' : `${progress.current}/${progress.max} to next level`}
                            </div>
                            
                            ${adminButtons}
                        </div>
                    `;
                }).join('');
            }

            // ... (outros m√©todos permanecem iguais)
        }

        // Initialize the application
        const englishQuest = new EnglishQuest();
        window.englishQuest = englishQuest;
    </script>
</body>
</html>
