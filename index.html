<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>English Class Positives and Negatives</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --bg-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --bg-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --bg-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    --bg-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --card: rgba(255, 255, 255, 0.95);
    --card-glass: rgba(255, 255, 255, 0.1);
    --text: #1a202c; --text-light: #4a5568; --text-muted: #718096;
    --primary: #667eea; --primary-dark: #5a67d8; --accent: #4facfe;
    --success: #48bb78; --warning: #ed8936; --danger: #f56565;
    --border: rgba(255, 255, 255, 0.2);
    --shadow-sm: 0 4px 6px rgba(0,0,0,.05);
    --shadow-md: 0 10px 25px rgba(0,0,0,.1);
    --shadow-lg: 0 20px 40px rgba(0,0,0,.15);
    --shadow-xl: 0 25px 50px rgba(0,0,0,.25);
    --radius: 20px; --radius-sm: 12px; --radius-lg: 28px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow-x:hidden}
  body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
       background:var(--bg-primary);color:var(--text);line-height:1.6;font-weight:400;position:relative}
  body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:-1;
    background:radial-gradient(circle at 20% 20%, rgba(120,119,198,.3) 0%, transparent 50%),
               radial-gradient(circle at 80% 80%, rgba(255,119,198,.3) 0%, transparent 50%),
               radial-gradient(circle at 40% 40%, rgba(79,172,254,.2) 0%, transparent 50%)}
  .container{max-width:1200px;margin:0 auto;padding:20px;position:relative;z-index:1}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes shimmer{0%{background-position:-468px 0}100%{background-position:468px 0}}

  /* ===== Header ===== */
  header{display:flex;flex-direction:column;align-items:center;gap:20px;margin-bottom:30px;animation:fadeInUp .8s ease-out}
  .brand{display:flex;align-items:center;gap:16px;background:var(--card);padding:20px 30px;border-radius:var(--radius-lg);
         box-shadow:var(--shadow-lg);backdrop-filter:blur(10px);border:1px solid var(--border)}
  .logo{width:56px;height:56px;border-radius:var(--radius-sm);background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        display:grid;place-items:center;box-shadow:var(--shadow-md);font-size:28px}
  .title{text-align:center}
  .title-main{font-size:clamp(28px,4vw,40px);font-weight:900;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.5px}
  .title-sub{margin-top:2px;font-size:clamp(14px,2.5vw,18px);font-weight:700;color:#2d3748;text-indent:.8em;opacity:.9}

  /* ===== Navega√ß√£o topo ===== */
  .tabs-top{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;background:var(--card-glass);
            padding:16px;border-radius:var(--radius-lg);backdrop-filter:blur(20px);border:1px solid var(--border);box-shadow:var(--shadow-md)}
  .tab-btn{font:inherit;border:none;border-radius:16px;padding:10px 14px;cursor:pointer;background:var(--card);
           display:inline-flex;align-items:center;gap:8px;font-size:13px;font-weight:700;box-shadow:var(--shadow-sm)}
  .tab-btn[aria-selected="true"]{background:var(--bg-primary);color:#fff}

  /* ===== Cards/Tabelas ===== */
  .card{background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);padding:30px;backdrop-filter:blur(20px);border:1px solid var(--border);animation:fadeInUp .6s ease-out;position:relative;overflow:hidden}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--bg-primary);border-radius:var(--radius-lg) var(--radius-lg) 0 0}
  .row{display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start}
  .col{flex:1 1 300px;animation:slideIn .5s ease-out}
  .control{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input,select{font:inherit;border:2px solid rgba(255,255,255,.3);border-radius:16px;padding:12px 16px;background:rgba(255,255,255,.9);color:var(--text);box-shadow:var(--shadow-sm)}
  input[type="number"]{width:100px}
  .btn{font:inherit;border-radius:16px;padding:10px 14px;border:none;background:var(--card);cursor:pointer;font-weight:700;box-shadow:var(--shadow-sm)}
  .btn-primary{background:var(--bg-primary);color:#fff}
  .btn-danger{background:var(--bg-warning);color:#fff}
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  .chip{background:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.3);padding:8px 14px;border-radius:25px;color:var(--text-light);font-size:13px;font-weight:600}

  /* ===== Linhas aluno ===== */
  .rowcard{display:grid;gap:15px;align-items:center;grid-template-columns:1fr 100px 120px 120px auto;
           padding:20px;border:1px solid rgba(255,255,255,.3);border-radius:16px;background:rgba(255,255,255,.95);margin-bottom:12px;backdrop-filter:blur(10px);box-shadow:var(--shadow-sm)}
  .rowcard.view{grid-template-columns:1fr repeat(3,120px) auto}
  .name{font-weight:700;font-size:16px}
  .mini{font-size:12px;color:var(--text-muted);font-weight:600}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:15px 0}
  .tab{padding:10px 16px;border-radius:20px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.9);cursor:pointer;font-size:14px;font-weight:700}
  .tab.active{background:var(--bg-primary);color:#fff}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin:20px 0}
  th,td{padding:16px 20px;background:rgba(255,255,255,.95);border:1px solid rgba(255,255,255,.3)}
  th{background:var(--bg-primary);color:#fff;text-align:left;font-weight:800}
  tr:hover td{background:#fff;transform:scale(1.02)}
  tr td:first-child, tr th:first-child{border-top-left-radius:16px;border-bottom-left-radius:16px}
  tr td:last-child,  tr th:last-child{border-top-right-radius:16px;border-bottom-right-radius:16px}
  .empty{color:var(--text-muted);border:2px dashed rgba(255,255,255,.5);padding:30px;border-radius:16px;background:rgba(255,255,255,.7);text-align:center;font-weight:700}
  .progress{height:20px;background:rgba(255,255,255,.3);border-radius:10px;position:relative;overflow:hidden;box-shadow:inset 0 2px 4px rgba(0,0,0,.1)}
  .progress .bar{height:100%;border-radius:10px;transition:width .8s cubic-bezier(.4,0,.2,1)}
  .progress.bad .bar{background:linear-gradient(135deg,#ff6b9d 0%,#f093fb 100%)}
  .progress.ok  .bar{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)}
  .progress.good.bar{background:var(--bg-success)}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent);margin:25px 0;border-radius:1px}
  .hidden{display:none !important}

  /* ===== Ajustes ESPEC√çFICOS da aba ADMIN (compactar) ===== */
  #adminSection .control .btn{padding:6px 10px;font-size:12px;border-radius:12px}
  #adminSection input, #adminSection select{padding:8px 10px;font-size:13px;border-radius:12px}
  #adminSection .rowcard{grid-template-columns:1fr 110px 120px 70px 70px auto;padding:14px}
  #adminSection .rowcard .pill{padding:4px 10px;font-size:12px}
  #adminSection .btn.mini{padding:6px 8px;font-size:12px;border-radius:10px}
  #adminSection .negToday{min-width:110px}
  #adminSection .posExtra{min-width:120px}
  #adminSection .negToday::placeholder{content:"Negativos"; opacity:.8}
  #adminSection .posExtra::placeholder{content:"Positivos extras"; opacity:.8}

  @media (max-width:768px){
    .card{padding:20px}
    .rowcard{grid-template-columns:1fr;gap:10px;text-align:center}
    .rowcard.view{grid-template-columns:1fr}
    .row{flex-direction:column}
    .control{justify-content:center}
    .tabs-top{padding:12px}
    .brand{padding:16px 20px}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand" aria-label="Marca do site">
      <div class="logo">üöÄ</div>
      <div class="title" role="heading" aria-level="1">
        <div class="title-main">English Class</div>
        <div class="title-sub">Positives and Negatives</div>
      </div>
    </div>
    <nav class="tabs-top" role="tablist" aria-label="Navega√ß√£o principal">
      <button class="tab-btn" role="tab" data-target="viewSection" aria-selected="true">üè´ Turmas</button>
      <button class="tab-btn" role="tab" data-target="studentSection" aria-selected="false">üßë‚Äçüéì Portal do Aluno</button>
      <button class="tab-btn" role="tab" data-target="reportsSection" aria-selected="false">üìä Relat√≥rios</button>
      <button class="tab-btn" role="tab" data-target="adminSection" aria-selected="false">üõ†Ô∏è Admin</button>
    </nav>
  </header>

  <!-- ===== TURMAS ===== -->
  <section id="viewSection" class="card">
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <div class="control">
          <input id="viewClassCode" placeholder="C√≥digo da Turma (ex.: 3B)" />
          <button class="btn btn-primary" id="btnLoadView">Carregar</button>
        </div>
      </div>
    </div>
    <div class="hr"></div>
    <div id="viewClassWrap" class="hidden">
      <div class="chips" style="margin-bottom:8px">
        <span class="chip">Turma: <b id="viewClassName"></b></span>
        <span class="chip">Alunos: <b id="viewCount"></b></span>
      </div>
      <div class="tabs" id="viewSortTabs">
        <button class="tab active" data-sort="az">A‚ÄìZ</button>
        <button class="tab" data-sort="pos">Mais Positivos</button>
        <button class="tab" data-sort="apr">Maior Aproveitamento</button>
      </div>
      <div id="viewList"></div>
    </div>
  </section>

  <!-- ===== PORTAL DO ALUNO ===== -->
  <section id="studentSection" class="card hidden" aria-hidden="true">
    <div class="row"><div class="col">
      <div class="control">
        <input id="studentClassCode" placeholder="C√≥digo da Turma (ex.: 3B)" />
        <input id="studentName" placeholder="Seu nome (igual ao cadastrado)" />
        <button class="btn btn-primary" id="btnLoadStudent">Ver meu relat√≥rio</button>
      </div>
    </div></div>
    <div class="hr"></div>
    <div id="studentWrap" class="hidden">
      <div class="row">
        <div class="col">
          <div class="chips">
            <span class="chip">Aluno: <b id="stName"></b></span>
            <span class="chip">Turma: <b id="stClass"></b></span>
          </div>
        </div>
        <div class="col">
          <div class="control" style="width:100%">
            <div style="flex:1">
              <div class="mini" style="margin-bottom:6px">Progresso acumulado</div>
              <div id="stProgress" class="progress"><div class="bar" style="width:0%"></div><div class="label">0%</div></div>
            </div>
            <div style="min-width:120px;text-align:center">
              <div class="mini">Tend√™ncia</div>
              <div id="stTrend" class="chip" style="display:inline-block;margin-top:4px">‚Äî</div>
            </div>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="mini" style="margin-bottom:8px">Datas avaliadas</div>
      <div id="stDateTabs" class="tabs"></div>
      <div id="stDailyWrap" class="hidden">
        <div class="chips" id="stDailyChips"></div>
        <table>
          <thead><tr><th>Dia</th><th>Negativos</th><th>Positivos</th><th>Faltou?</th><th>% do dia</th></tr></thead>
          <tbody id="stDailyBody"></tbody>
        </table>
      </div>
      <div id="stEmpty" class="empty hidden">Nenhuma data lan√ßada para este aluno ainda.</div>
    </div>
  </section>

  <!-- ===== RELAT√ìRIOS ===== -->
  <section id="reportsSection" class="card hidden" aria-hidden="true">
    <div class="row" style="align-items:flex-end">
      <div class="col">
        <div class="control">
          <input id="reportClassCode" placeholder="C√≥digo da Turma (ex.: 3B)" />
          <button class="btn btn-primary" id="btnLoadReport">Carregar</button>
        </div>
      </div>
      <div class="col">
        <div class="tabs">
          <button class="tab active" id="tabDaily">Por dia</button>
          <button class="tab" id="tabAccum">Acumulado</button>
        </div>
      </div>
    </div>
    <div id="dailyPane">
      <div id="dateTabs" class="tabs"></div>
      <div class="chips" id="dailyChips"></div>
      <div id="dailyTableWrap">
        <table id="dailyTable">
          <thead><tr><th>Aluno</th><th>Negativos (dia)</th><th>Positivos (dia)</th><th>Faltou?</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="dailyEmpty" class="empty hidden">Nenhuma data avaliada ainda para esta turma.</div>
      </div>
      <div class="control" style="margin-top:8px">
        <button id="btnExportDaily" class="btn">‚¨áÔ∏è Exportar CSV (dia)</button>
      </div>
    </div>
    <div id="accumPane" class="hidden">
      <div class="chips"><span class="chip">Aproveitamento = max(0, (Pos ‚àí Neg) / Pos) √ó 100</span></div>
      <table id="accumTable">
        <thead><tr><th>Aluno</th><th>Negativos (total)</th><th>Positivos (total)</th><th>Aproveitamento</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="control" style="margin-top:8px">
        <button id="btnExportAccum" class="btn">‚¨áÔ∏è Exportar CSV (acumulado)</button>
      </div>
    </div>
  </section>

  <!-- ===== ADMIN ===== -->
  <section id="adminSection" class="card hidden" aria-hidden="true">
    <div id="loginBox">
      <div class="row"><div class="col">
        <div class="control">
          <input id="adminPassword" type="password" placeholder="Senha" />
          <button class="btn btn-primary" id="btnLogin">Entrar</button>
        </div>
        <div class="mini" style="margin-top:6px">Dica: seus dados ficam neste navegador (use Exportar/Importar para backup).</div>
      </div></div>
    </div>

    <div id="adminBox" class="hidden">
      <div class="row">
        <div class="col">
          <div class="mini">Turma</div>
          <div class="control">
            <select id="classSelect"></select>
            <button class="btn" id="btnNewClass">+ Nova turma</button>
            <button class="btn" id="btnEditClass">‚úèÔ∏è Editar turma</button>
            <button class="btn btn-danger" id="btnDeleteClass">Excluir turma</button>
          </div>
        </div>
        <div class="col">
          <div class="mini">Novo aluno</div>
          <div class="control">
            <input id="newStudentName" placeholder="Nome do aluno" />
            <button class="btn" id="btnAddStudent">+ Adicionar</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="align-items:flex-end">
        <div class="col">
          <div class="mini">Data do dia</div>
          <input id="sessionDate" type="date" />
        </div>
        <div class="col">
          <div class="mini">Positivos avaliados (padr√£o 8)</div>
          <input id="evaluatedPos" type="number" min="0" step="1" value="8" />
        </div>
        <div class="col">
          <div class="control">
            <button class="btn" id="btnZeros">Zerar campos do dia</button>
            <button class="btn btn-primary" id="btnSaveDay">üíæ Salvar Dia</button>
          </div>
        </div>
        <div class="col">
          <div class="control">
            <button class="btn" id="btnExport">‚¨áÔ∏è Exportar JSON</button>
            <input id="importFile" type="file" accept="application/json" class="hidden" />
            <button class="btn" id="btnImport">‚¨ÜÔ∏è Importar JSON</button>
            <button class="btn btn-danger" id="btnReset">üßπ Reset</button>
          </div>
        </div>
      </div>

      <div class="mini" style="margin:10px 0">Marque <b>Faltou</b> quando o aluno n√£o assistiu (nada √© aplicado no dia).</div>
      <div id="editList" style="margin-top:6px"></div>
    </div>
  </section>
</div>

<script>
/* ===== Estado base ===== */
const STORAGE_KEY='ec_points_v1';
const PRELOADED_STATE={
  adminPassword:'051024', // senha solicitada
  classes:{}
};
function loadState(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw){ localStorage.setItem(STORAGE_KEY, JSON.stringify(PRELOADED_STATE)); return PRELOADED_STATE; }
  try{ return JSON.parse(raw);}catch(e){ alert('Dados corrompidos. Iniciando do zero.'); localStorage.removeItem(STORAGE_KEY); return loadState(); }
}
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
let state=loadState();
let isAuthed=false;
let currentViewCode='';
let currentSelectedReportDate='';
let currentViewSort='az';

const $=s=>document.querySelector(s);
const $$=s=>[...document.querySelectorAll(s)];
function todayISO(){return new Date().toISOString().slice(0,10);}
function n(x){return Number(x||0);}
function computeAproveitamento(pos,neg){ if(pos<=0) return 0; const p=((pos-neg)/pos)*100; return Math.max(0,Math.min(100,p)); }

/* ===== Navega√ß√£o ===== */
function setActiveSection(sectionId){
  ['viewSection','studentSection','reportsSection','adminSection'].forEach(id=>{
    const el=document.getElementById(id);
    if(id===sectionId){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    else{ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }
  });
  $$('.tab-btn').forEach(btn=>{
    const on = btn.dataset.target===sectionId;
    btn.setAttribute('aria-selected', on ? 'true' : 'false');
  });
  location.hash = '#'+sectionId;
}
$$('.tab-btn').forEach(btn=> btn.addEventListener('click', ()=> setActiveSection(btn.dataset.target)));
window.addEventListener('load', ()=>{ setActiveSection((location.hash||'#viewSection').replace('#','')); });
window.addEventListener('hashchange', ()=>{ setActiveSection((location.hash||'#viewSection').replace('#','')); });

/* ===== TURMAS (view) ===== */
function renderViewList(cls){
  const wrap=$('#viewList'); wrap.innerHTML='';
  let items = Object.entries(cls.students||{}).map(([name,data])=>{
    const neg=n(data.totals?.neg), pos=n(data.totals?.pos), apr=computeAproveitamento(pos,neg);
    return {name, neg, pos, apr, total: pos - neg};
  });
  if(currentViewSort==='az') items.sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
  if(currentViewSort==='pos') items.sort((a,b)=> b.pos - a.pos || a.name.localeCompare(b.name,'pt-BR'));
  if(currentViewSort==='apr') items.sort((a,b)=> b.apr - a.apr || a.name.localeCompare(b.name,'pt-BR'));

  $('#viewCount').textContent=items.length;
  items.forEach((it, idx)=>{
    const rank = (currentViewSort==='az') ? '' : `<span class="mini" style="color:#475569">#${idx+1}</span>`;
    const row=document.createElement('div'); row.className='rowcard view';
    row.innerHTML=`<div class="name">üìò ${it.name} ${rank}</div>
                   <div class="pill neg">-${it.neg}</div>
                   <div class="pill pos">+${it.pos}</div>
                   <div class="pill total">${it.total}</div>
                   <div style="justify-self:end"><div class="mini">Aprov.: <b>${Math.round(it.apr)}%</b></div></div>`;
    wrap.appendChild(row);
  });
}
function attachViewSortTabs(){
  const tabs = $('#viewSortTabs');
  tabs.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      currentViewSort = btn.dataset.sort;
      const code=currentViewCode;
      if(code && state.classes[code]) renderViewList(state.classes[code]);
    });
  });
}
$('#btnLoadView').onclick=()=>{
  const code=$('#viewClassCode').value.trim(); if(!code) return;
  const cls=state.classes[code]; if(!cls){ alert('Turma n√£o encontrada.'); return; }
  currentViewCode=code; $('#viewClassName').textContent=cls.name||cls.code;
  $('#viewClassWrap').classList.remove('hidden'); renderViewList(cls); attachViewSortTabs();
};

/* ===== ADMIN ===== */
function renderEditList(cls){
  const wrap=$('#editList'); wrap.innerHTML='';
  const students=Object.entries(cls.students||{}).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR'));
  students.forEach(([name,data])=>{
    const totalNeg=n(data.totals?.neg), totalPos=n(data.totals?.pos);
    const row=document.createElement('div'); row.className='rowcard'; row.dataset.name=name;
    row.innerHTML=`
      <div>
        <div class="name">üß© ${name}</div>
        <div class="mini">Faltou? <input type="checkbox" class="absent" /></div>
      </div>
      <input type="number" min="0" step="1" class="negToday" placeholder="Negativos" />
      <input type="number" min="0" step="1" class="posExtra" placeholder="Positivos extras" />
      <div class="pill neg">-${totalNeg}</div>
      <div class="pill pos">+${totalPos}</div>
      <div class="control" style="justify-self:end">
        <button class="btn mini btnMinus">+1 Neg</button>
        <button class="btn mini btnPlus">+1 PosExtra</button>
        <button class="btn btn-danger mini btnRemove">Excluir</button>
      </div>`;
    row.querySelector('.btnPlus').onclick=()=>{ const i=row.querySelector('.posExtra'); i.value=n(i.value)+1; };
    row.querySelector('.btnMinus').onclick=()=>{ const i=row.querySelector('.negToday'); i.value=n(i.value)+1; };
    row.querySelector('.btnRemove').onclick=()=>{ if(confirm('Remover aluno "'+name+'"?')){ delete cls.students[name]; saveState(state); renderEditList(cls); if(currentViewCode===cls.code) renderViewList(cls); } };
    wrap.appendChild(row);
  });
}
$('#btnLogin').onclick=()=>{ const pass=$('#adminPassword').value;
  if(pass === (state.adminPassword||'051024')){ isAuthed=true; $('#loginBox').classList.add('hidden'); $('#adminBox').classList.remove('hidden');
    populateClassSelect(); if(!$('#sessionDate').value) $('#sessionDate').value=todayISO();
    const code=$('#classSelect').value; if(code){ renderEditList(state.classes[code]); if(currentViewCode===code) renderViewList(state.classes[code]); }
  } else alert('Senha incorreta.'); };
function populateClassSelect(){
  const sel=$('#classSelect'); sel.innerHTML='';
  Object.values(state.classes||{}).sort((a,b)=>a.code.localeCompare(b.code,'pt-BR')).forEach(c=>{
    const opt=document.createElement('option'); opt.value=c.code; opt.textContent=`${c.code} ‚Äî ${c.name||c.code}`; sel.appendChild(opt);
  });
}
$('#classSelect').addEventListener('change', (e)=>{ const code=e.target.value; const cls=state.classes[code]; if(cls){ renderEditList(cls); if(currentViewCode===code) renderViewList(cls); } });
$('#btnNewClass').onclick=()=>{ const code=prompt('C√≥digo da turma (ex.: 3A):'); if(!code) return;
  if(state.classes[code]) return alert('J√° existe.'); const name=prompt('Nome da turma (vis√≠vel aos alunos):', code);
  state.classes[code]={name, code, students:{}}; saveState(state);
  populateClassSelect(); $('#classSelect').value=code; renderEditList(state.classes[code]); };
$('#btnEditClass').onclick=()=>{ const old=$('#classSelect').value; if(!old) return alert('Selecione uma turma.');
  const cls=state.classes[old]; const newCode=prompt('Novo c√≥digo da turma:', cls.code); if(!newCode) return;
  const newName=prompt('Novo nome da turma (vis√≠vel aos alunos):', cls.name||cls.code) ?? cls.name||cls.code;
  if(newCode!==old && state.classes[newCode]) return alert('J√° existe uma turma com esse c√≥digo.');
  delete state.classes[old]; cls.code=newCode; cls.name=newName; state.classes[newCode]=cls; saveState(state);
  populateClassSelect(); $('#classSelect').value=newCode; renderEditList(cls); if(currentViewCode===old){ currentViewCode=newCode; renderViewList(cls); } };
$('#btnDeleteClass').onclick=()=>{ const code=$('#classSelect').value; if(!code) return; if(!confirm('Excluir turma "'+code+'"?')) return;
  delete state.classes[code]; saveState(state); populateClassSelect(); $('#editList').innerHTML=''; if(currentViewCode===code){ $('#viewList').innerHTML=''; $('#viewClassWrap').classList.add('hidden'); currentViewCode=''; } };
$('#btnAddStudent').onclick=()=>{ const code=$('#classSelect').value; if(!code) return alert('Selecione uma turma.');
  const name=$('#newStudentName').value.trim(); if(!name) return; const cls=state.classes[code]; if(cls.students[name]) return alert('Aluno j√° existe.');
  cls.students[name]={totals:{neg:0,pos:0}, history:[]}; $('#newStudentName').value=''; saveState(state); renderEditList(cls); if(currentViewCode===code) renderViewList(cls); };

function applySaveDay(){
  const code=$('#classSelect').value; const cls=state.classes[code]; if(!cls) return alert('Selecione uma turma.');
  const date=$('#sessionDate').value||todayISO(); const evaluated=n($('#evaluatedPos').value||8);
  [...document.querySelectorAll('#editList .rowcard')].forEach(row=>{
    const name=row.dataset.name; const s=cls.students[name]; if(!s) return;
    const absent=row.querySelector('.absent').checked;
    const negToday=n(row.querySelector('.negToday').value);
    const posExtra=n(row.querySelector('.posExtra').value);
    if(absent){ s.history=s.history||[]; s.history.push({date, absent:true}); row.querySelector('.negToday').value=''; row.querySelector('.posExtra').value=''; return; }
    const baseApplied=Math.max(0, evaluated - negToday);
    const consistency=negToday===0?3:0;
    const posAdded=baseApplied + posExtra + consistency;
    s.totals=s.totals||{neg:0,pos:0}; s.totals.pos=n(s.totals.pos)+posAdded; s.totals.neg=n(s.totals.neg)+negToday;
    s.history=s.history||[]; s.history.push({date, neg:negToday, posExtra, evaluated, applied:{baseApplied, consistency, posAdded}});
    row.querySelector('.negToday').value=''; row.querySelector('.posExtra').value='';
  });
  saveState(state);
  renderEditList(cls); if(currentViewCode===code) renderViewList(cls);
  if(!$('#reportsSection').classList.contains('hidden')){ renderDateTabs(code); renderAccumReport(code); }
  alert('Dia salvo para '+code+' em '+date+'.');
}
$('#btnSaveDay').onclick=applySaveDay;
$('#btnZeros').onclick=()=>{ $$('.negToday,.posExtra,.absent').forEach(i=>{ if(i.type==='checkbox') i.checked=false; else i.value=''; }); };
$('#btnExport').onclick=()=>{ const data=JSON.stringify(state,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='english-class.json'; a.click(); URL.revokeObjectURL(url); };
$('#btnImport').onclick=()=>$('#importFile').click();
$('#importFile').addEventListener('change',(e)=>{ const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader(); reader.onload=()=>{ try{
    const json=JSON.parse(reader.result); if(!json || !json.classes) throw new Error('Arquivo inv√°lido.');
    state=json; saveState(state); populateClassSelect(); const code=$('#classSelect').value; if(code){ renderEditList(state.classes[code]); if(currentViewCode===code) renderViewList(state.classes[code]); } alert('Importado com sucesso!');
  }catch(err){ alert('Falha ao importar: '+err.message); } }; reader.readAsText(file); });
$('#btnReset').onclick=()=>{ if(!confirm('Apagar TUDO deste navegador e restaurar padr√£o (vazio)?')) return;
  localStorage.removeItem(STORAGE_KEY); state=PRELOADED_STATE; saveState(state); populateClassSelect(); $('#editList').innerHTML=''; $('#viewList').innerHTML=''; $('#viewClassWrap').classList.add('hidden'); currentViewCode=''; alert('Tudo limpo.'); };

/* ===== RELAT√ìRIOS ===== */
function buildDailyMap(cls){
  const map={}; Object.entries(cls.students||{}).forEach(([name,s])=>{ (s.history||[]).forEach(h=>{
    const d=h.date; if(!d) return; if(!map[d]) map[d]={byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
    const ent=map[d].byStudent[name] || {neg:0,pos:0,absent:false};
    if(h.absent){ ent.absent=true; map[d].totals.absentCount++; }
    if(typeof h.neg==='number'){ ent.neg+=h.neg; map[d].totals.neg+=h.neg; }
    const posAdded=h?.applied?.posAdded ?? 0; if(posAdded){ ent.pos+=posAdded; map[d].totals.pos+=posAdded; }
    map[d].byStudent[name]=ent; }); }); return map;
}
function formatDateLabel(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); return `${d}/${m}`; }
function renderDateTabs(code){
  const cls=state.classes[code]; if(!cls) return;
  const map=buildDailyMap(cls); const dates=Object.keys(map).sort((a,b)=>b.localeCompare(a));
  const tabs=$('#dateTabs'); tabs.innerHTML=''; if(dates.length===0){ $('#dailyTable').classList.add('hidden'); $('#dailyEmpty').classList.remove('hidden'); $('#dailyChips').innerHTML=''; currentSelectedReportDate=''; return; }
  $('#dailyTable').classList.remove('hidden'); $('#dailyEmpty').classList.add('hidden'); if(!currentSelectedReportDate || !map[currentSelectedReportDate]) currentSelectedReportDate=dates[0];
  dates.forEach(d=>{ const b=document.createElement('button'); b.className='tab'+(d===currentSelectedReportDate?' active':''); b.textContent=formatDateLabel(d); b.title=d;
    b.onclick=()=>{ currentSelectedReportDate=d; [...tabs.querySelectorAll('.tab')].forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderDailyReport(code,d); }; tabs.appendChild(b); });
  renderDailyReport(code,currentSelectedReportDate);
}
function renderDailyReport(code,dateStr){
  const cls=state.classes[code]; const map=buildDailyMap(cls); const day=map[dateStr]||{byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
  $('#dailyChips').innerHTML=`<span class="chip">Turma: <b>${cls.name||cls.code}</b></span>
                              <span class="chip">Data: <b>${dateStr||'‚Äî'}</b></span>
                              <span class="chip">Negativos: <b>${day.totals.neg||0}</b></span>
                              <span class="chip">Positivos: <b>${day.totals.pos||0}</b></span>
                              <span class="chip">Faltas: <b>${day.totals.absentCount||0}</b></span>`;
  const tbody=$('#dailyTable tbody'); tbody.innerHTML=''; const names=Object.keys(cls.students||{}).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  names.forEach(nm=>{ const st=day.byStudent[nm]||{neg:0,pos:0,absent:false}; const tr=document.createElement('tr');
    tr.innerHTML=`<td>üìò ${nm}</td><td>${st.neg||0}</td><td>${st.pos||0}</td><td>${st.absent?'Sim':''}</td>`; tbody.appendChild(tr); });
}
function renderAccumReport(code){
  const cls=state.classes[code]; const tbody=$('#accumTable tbody'); tbody.innerHTML='';
  Object.entries(cls.students||{}).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([name,s])=>{
    const neg=n(s?.totals?.neg), pos=n(s?.totals?.pos), perc=computeAproveitamento(pos,neg);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>üìò ${name}</td><td>${neg}</td><td>${pos}</td><td>${perc.toFixed(0)}%</td>`; tbody.appendChild(tr);
  });
}
$('#btnLoadReport').onclick=()=>{ const code=$('#reportClassCode').value.trim(); if(!code) return;
  if(!state.classes[code]){ alert('Turma n√£o encontrada.'); return; }
  currentViewCode=code; renderDateTabs(code); renderAccumReport(code);
};
$('#tabDaily').onclick=()=>{ $('#tabDaily').classList.add('active'); $('#tabAccum').classList.remove('active'); $('#dailyPane').classList.remove('hidden'); $('#accumPane').classList.add('hidden'); };
$('#tabAccum').onclick=()=>{ $('#tabAccum').classList.add('active'); $('#tabDaily').classList.remove('active'); $('#accumPane').classList.remove('hidden'); $('#dailyPane').classList.add('hidden'); };
$('#btnExportDaily').onclick=()=>{ const code=$('#reportClassCode').value.trim()||currentViewCode; if(!code||!currentSelectedReportDate) return; exportDailyCSV(code,currentSelectedReportDate); };
$('#btnExportAccum').onclick=()=>{ const code=$('#reportClassCode').value.trim()||currentViewCode; if(!code) return; exportAccumCSV(code); };
function downloadCSV(name,text){ const b=new Blob([text],{type:'text/csv;charset=utf-8;'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
function exportDailyCSV(code,dateStr){
  const cls=state.classes[code]; if(!cls) return; const map=buildDailyMap(cls); const day=map[dateStr]||{byStudent:{}, totals:{neg:0,pos:0,absentCount:0}};
  const names=Object.keys(cls.students||{}).sort((a,b)=>a.localeCompare(b,'pt-BR')); let csv=`Turma,${cls.name||cls.code}\nData,${dateStr}\n\nAluno,Negativos (dia),Positivos (dia),Faltou?\n`;
  names.forEach(nm=>{ const st=day.byStudent[nm]||{neg:0,pos:0,absent:false}; csv+=`"${nm}",${st.neg||0},${st.pos||0},${st.absent?'Sim':''}\n`; });
  csv+=`\nResumo,,,\nTotal Negativos,${day.totals.neg||0}\nTotal Positivos,${day.totals.pos||0}\nFaltas,${day.totals.absentCount||0}\n`; downloadCSV(`relatorio-dia-${code}-${dateStr||'sem_data'}.csv`,csv);
}
function exportAccumCSV(code){
  const cls=state.classes[code]; if(!cls) return; let csv=`Turma,${cls.name||cls.code}\n\nAluno,Negativos (total),Positivos (total),Aproveitamento (%)\n`;
  Object.entries(cls.students||{}).sort((a,b)=>a[0].localeCompare(b[0],'pt-BR')).forEach(([nm,s])=>{
    const neg=n(s?.totals?.neg), pos=n(s?.totals?.pos), perc=computeAproveitamento(pos,neg).toFixed(0); csv+=`"${nm}",${neg},${pos},${perc}\n`;
  }); downloadCSV(`relatorio-acumulado-${code}.csv`,csv);
}

/* ===== PORTAL DO ALUNO ===== */
function classAndStudent(code,name){ const cls=state.classes[code]; if(!cls) return [null,null];
  const entry=Object.entries(cls.students||{}).find(([n])=>n.trim().toLowerCase()===name.trim().toLowerCase()); return [cls, entry? {key:entry[0], data:entry[1]} : null]; }
function buildStudentDays(student){
  const map={}; (student.history||[]).forEach(h=>{ if(!h.date) return;
    if(!map[h.date]) map[h.date]={date:h.date,neg:0,pos:0,absent:false};
    if(h.absent){ map[h.date].absent=true; } if(typeof h.neg==='number') map[h.date].neg+=h.neg;
    const p=h?.applied?.posAdded ?? 0; if(p) map[h.date].pos+=p; });
  const days=Object.values(map).sort((a,b)=>a.date.localeCompare(b.date));
  days.forEach(d=>{ d.percDay = d.pos>0 ? Math.max(0, Math.min(100, ((d.pos - d.neg)/d.pos)*100 )) : 0; }); return days;
}
function setProgressBar(el, percent){
  const bar=el.querySelector('.bar'), label=el.querySelector('.label'); bar.style.width=Math.round(percent)+'%'; label.textContent=Math.round(percent)+'%';
  el.classList.remove('bad','ok','good'); if(percent<40) el.classList.add('bad'); else if(percent<70) el.classList.add('ok'); else el.classList.add('good');
}
function renderStudentPortal(code, rawName){
  const [cls, stObj]=classAndStudent(code, rawName); const wrap=$('#studentWrap'); const empty=$('#stEmpty');
  if(!cls || !stObj){ wrap.classList.add('hidden'); empty.classList.remove('hidden'); empty.textContent='N√£o encontrei essa turma/aluno. Verifique o nome como cadastrado.'; return; }
  const name=stObj.key, st=stObj.data; $('#stName').textContent=name; $('#stClass').textContent=cls.name||cls.code;
  const totPos=n(st?.totals?.pos), totNeg=n(st?.totals?.neg); const percAccum=computeAproveitamento(totPos, totNeg); setProgressBar($('#stProgress'), percAccum);
  const days=buildStudentDays(st); const tabs=$('#stDateTabs'); tabs.innerHTML=''; const dailyBody=$('#stDailyBody'); dailyBody.innerHTML=''; const chips=$('#stDailyChips');
  if(days.length===0){ wrap.classList.remove('hidden'); empty.classList.remove('hidden'); $('#stDailyWrap').classList.add('hidden'); return; }
  $('#stDailyWrap').classList.remove('hidden'); empty.classList.add('hidden'); wrap.classList.remove('hidden');
  let trend='‚Äî'; if(days.length>=2){ const a=days[days.length-2].percDay, b=days[days.length-1].percDay; trend = (b>a)?('‚¨ÜÔ∏è +'+Math.round(b-a)+'%'):(b<a)?('‚¨áÔ∏è '+Math.round(b-a)+'%'):'‚Üí 0%'; } $('#stTrend').textContent=trend;
  let selected=days[days.length-1].date;
  function paintDay(date){
    const d=days.find(x=>x.date===date); if(!d) return;
    chips.innerHTML = `<span class="chip">Data: <b>${date}</b></span>
                       <span class="chip">Negativos: <b>${d.neg}</b></span>
                       <span class="chip">Positivos: <b>${d.pos}</b></span>
                       <span class="chip">Faltou: <b>${d.absent?'Sim':'N√£o'}</b></span>
                       <span class="chip">% do dia: <b>${Math.round(d.percDay)}%</b></span>`;
    dailyBody.innerHTML=`<tr><td>üìÖ ${date}</td><td>${d.neg}</td><td>${d.pos}</td><td>${d.absent?'Sim':'N√£o'}</td><td>${Math.round(d.percDay)}%</td></tr>`;
  }
  days.forEach(d=>{ const b=document.createElement('button'); b.className='tab'+(d.date===selected?' active':''); b.textContent=formatDateLabel(d.date); b.title=d.date;
    b.onclick=()=>{ selected=d.date; [...tabs.querySelectorAll('.tab')].forEach(t=>t.classList.remove('active')); b.classList.add('active'); paintDay(selected); }; tabs.appendChild(b); });
  paintDay(selected);
}
$('#btnLoadStudent').onclick=()=>{ const code=$('#studentClassCode').value.trim(); const name=$('#studentName').value.trim(); if(!code||!name){ alert('Preencha turma e seu nome.'); return; } renderStudentPortal(code,name); };
</script>
</body>
</html>
